


// const axios = require('axios');
// const { sendWhatsAppMessage } = require('../services/whatsappService');

// const users = [
//   { name: 'Abhiram', clockifyId: '682ebe69a9a5d61a4c016a94', phone: '918590292642' },
//   { name: 'Lakshmi', clockifyId: '67975db1c0283f7b17cc71d8', phone: '918590302743' },
//   { name: 'Sanu', clockifyId: '685e2baa30158b1c138222d3', phone: '919496649110' },
// ];

// const adminPhone = '918590292642';
// const workspaceId = process.env.CLOCKIFY_WORKSPACE_ID;
// const clockifyApiKey = process.env.CLOCKIFY_API_KEY;

// let firstRunCompleted = false;

// // Track which user got which hour alert today
// const hourAlertSent = {};

// async function checkUsersStarted() {
//   // Convert to India time (GMT+5:30)
//   const now = new Date();
//   const indiaTime = new Date(now.getTime() + (5.5 * 60 * 60 * 1000)); // Add 5.5 hours for GMT+5:30
//   const currentHour = indiaTime.getUTCHours();      // 0‚Äì23
//   const currentMinute = indiaTime.getUTCMinutes();  // 0‚Äì59
//   const currentTime = currentHour * 60 + currentMinute;

//   const startMinutes = 9 * 60 + 30;   // 9:30 AM = 570
//   const endMinutes = 17 * 60;         // 5:00 PM = 1020

//   console.log(`üïê Current India time: ${currentHour}:${currentMinute.toString().padStart(2, '0')} (${currentTime} minutes)`);
//   console.log(`‚è∞ Working hours: 9:30-17:00 (${startMinutes}-${endMinutes} minutes)`);

//   // ‚õî DO NOTHING if not between 9:30 AM and 5:00 PM
//   if (currentTime < startMinutes || currentTime >= endMinutes) {
//     console.log("‚èπÔ∏è Skipping Clockify check ‚Äî outside working hours (9:30‚Äì17:00). No messages sent.");
//     return;
//   }

//   const isFirstRun = currentHour === 10 && currentMinute < 20;
//   if (isFirstRun) {
//     firstRunCompleted = false; // Reset at 10 AM
//   }

//   console.log(`üîÅ Running Clockify check at ${currentHour}:${currentMinute.toString().padStart(2, '0')} (India time)`);

//   const notStarted = [];
//   const hourAlerts = []; // Users who crossed hour thresholds

//   for (const user of users) {
//     try {
//       const url = `https://api.clockify.me/api/v1/workspaces/${workspaceId}/user/${user.clockifyId}/time-entries?in-progress=true`;

//       console.log(`üöÄ Checking user: ${user.name}`);
//       const res = await axios.get(url, {
//         headers: { 'X-Api-Key': clockifyApiKey }
//       });

//       if (!res.data || res.data.length === 0) {
//         console.log(`‚õîÔ∏è ${user.name} has NOT started Clockify`);
//         notStarted.push(user);
//       } else {
//         console.log(`‚úÖ ${user.name} has an ACTIVE timer`);
//         // Check if timer is running for more than 1 hour
//         const entry = res.data[0];
//         if (entry.timeInterval && entry.timeInterval.start) {
//           const startTime = new Date(entry.timeInterval.start);
//           const nowTime = new Date();
//           const durationMs = nowTime - startTime;
//           const durationHr = durationMs / (1000 * 60 * 60);

//           console.log(`‚è≥ ${user.name} timer duration: ${durationHr.toFixed(2)} hours`);

//           // Alert if timer is more than 1 hour (60 minutes)
//           const todayKey = nowTime.toISOString().slice(0,10); // YYYY-MM-DD
//           const alertKey = `${user.clockifyId}_${todayKey}`;
//           if (durationHr > 1 && !hourAlertSent[alertKey]) {
//             hourAlerts.push({
//               ...user,
//               duration: durationHr.toFixed(2),
//               project: entry.projectId || 'Unknown'
//             });
//             hourAlertSent[alertKey] = true;
//           }
//         }
//       }
//     } catch (err) {
//       console.error(`‚ùå Error checking ${user.name}:`, err.message);
//       notStarted.push({ ...user, error: err.message });
//     }
//   }

//   if (notStarted.length > 0 || isFirstRun) {
//     const details = notStarted.map(u => `${u.name}${u.error ? ' (error: ' + u.error + ')' : ''}`).join('\n');

//     try {
//       if (notStarted.length > 0) {
//         for (const user of notStarted) {
//           try {
//             await sendWhatsAppMessage(user.phone, `‚ö†Ô∏è You haven't started your Clockify timer today. Please start it now.`);
//           } catch (error) {
//             console.error(`‚ùå Failed to send WhatsApp message to ${user.name}:`, error.message);
//           }
//         }

//         const adminMsg = `‚ö†Ô∏è Clockify Alert:\nThe following users have not logged time today:\n${details}`;
//         await sendWhatsAppMessage(adminPhone, adminMsg);
//       } else {
//         await sendWhatsAppMessage(adminPhone, `‚úÖ All users have logged time today.`);
//       }
//     } catch (error) {
//       console.error('‚ùå Failed to send WhatsApp messages:', error.message);
//     }
//   }

//   // Send funny alerts for > 1 hour
//   if (hourAlerts.length > 0) {
//     for (const user of hourAlerts) {
//       const msg = `üê¢ You Are Working Like a Turtle! Be a Rabbit, Be Fast! (You have been on this project for ${user.duration} hours)`;
//       console.log(`ALERT for ${user.name}: ${msg}`);
//       await sendWhatsAppMessage(user.phone, msg);
//     }
//     const adminMsg = `üê¢ Turtle Alert:\n${hourAlerts.map(u => `${u.name} (${u.duration} hr) - timer > 1 hr`).join('\n')}`;
//     await sendWhatsAppMessage(adminPhone, adminMsg);
//   }

//   firstRunCompleted = true;
// }

// module.exports = checkUsersStarted;



// clockifyChecker.js
const axios = require('axios');
const { sendWhatsAppMessage } = require('../services/whatsappService');

const users = [
  { name: 'Abhiram', clockifyId: '682ebe69a9a5d61a4c016a94', phone: '918590292642' },
  { name: 'Lakshmi', clockifyId: '67975db1c0283f7b17cc71d8', phone: '918590302743' },
  { name: 'Sanu', clockifyId: '685e2baa30158b1c138222d3', phone: '919496649110' },
];

const adminPhone = '919562684960';
const workspaceId = process.env.CLOCKIFY_WORKSPACE_ID;
const clockifyApiKey = process.env.CLOCKIFY_API_KEY;

// Track which user got the ‚Äú>1 hour on same timer‚Äù alert today
const hourAlertSent = Object.create(null);

// ‚Äî‚Äî Time helpers (robust IST handling) ‚Äî‚Äî
function nowInIST() {
  // Avoid adding 5.5h to local time (buggy). Use timezone conversion instead.
  return new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Kolkata' }));
}
function startOfDayIST(d = nowInIST()) {
  return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0);
}
function toIsoUTC(dateIst) {
  // Convert an IST Date object‚Äôs *wall clock* to UTC ISO string that Clockify expects.
  const utc = new Date(dateIst.getTime() - (dateIst.getTimezoneOffset() * 60000));
  return utc.toISOString();
}
function minutesSinceMidnightIST(d = nowInIST()) {
  return d.getHours() * 60 + d.getMinutes();
}

// ‚Äî‚Äî Clockify helpers ‚Äî‚Äî
async function getInProgressEntry(userId) {
  const url = `https://api.clockify.me/api/v1/workspaces/${workspaceId}/user/${userId}/time-entries?in-progress=true`;
  const res = await axios.get(url, { headers: { 'X-Api-Key': clockifyApiKey } });
  return Array.isArray(res.data) && res.data[0] ? res.data[0] : null;
}

async function getTodayEntries(userId) {
  const istNow = nowInIST();
  const dayStartIST = startOfDayIST(istNow);
  const startISO = toIsoUTC(dayStartIST);
  const endISO = toIsoUTC(istNow);

  // Pull today's entries (Clockify supports filters via query params)
  const url = `https://api.clockify.me/api/v1/workspaces/${workspaceId}/user/${userId}/time-entries` +
              `?start=${encodeURIComponent(startISO)}&end=${encodeURIComponent(endISO)}&page-size=500`;
  const res = await axios.get(url, { headers: { 'X-Api-Key': clockifyApiKey } });
  return Array.isArray(res.data) ? res.data : [];
}

// Sum duration (in ms) of an entry; support running entries (no end)
function entryDurationMs(entry, now = new Date()) {
  const s = entry?.timeInterval?.start ? new Date(entry.timeInterval.start) : null;
  const e = entry?.timeInterval?.end ? new Date(entry.timeInterval.end) : null;
  if (!s) return 0;
  return (e ? e : now) - s;
}

// Group today‚Äôs entries by project and sum durations
function summarizeByProject(entries) {
  const map = new Map(); // projectId => { ms, count }
  for (const e of entries) {
    const pid = e.projectId || 'Unknown';
    const prev = map.get(pid) || { ms: 0, count: 0 };
    prev.ms += entryDurationMs(e, new Date());
    prev.count += 1;
    map.set(pid, prev);
  }
  // Return sorted array by time desc
  return [...map.entries()]
    .map(([projectId, v]) => ({ projectId, ms: v.ms, count: v.count }))
    .sort((a, b) => b.ms - a.ms);
}

function hrs(ms) {
  return (ms / 3_600_000).toFixed(2);
}

// ‚Äî‚Äî Main check ‚Äî‚Äî
async function checkUsersStarted() {
  const istNow = nowInIST();
  const currentMin = minutesSinceMidnightIST(istNow);

  // Work window 09:00‚Äì17:00 IST (exclusive end)
  const startMinutes = 9 * 60;     // 540
  const endMinutes   = 17 * 60;    // 1020

  console.log(`üïê IST now: ${istNow.toTimeString().slice(0,5)} (${currentMin} minutes)`);

  if (currentMin < startMinutes || currentMin >= endMinutes) {
    console.log('‚èπÔ∏è Outside working hours (09:00‚Äì17:00 IST). Skipping.');
    return;
  }

  // Reset hour-alert bookeeping daily (keyed by date)
  const todayKey = istNow.toISOString().slice(0, 10);
  // Prune old keys
  Object.keys(hourAlertSent).forEach(k => {
    if (!k.endsWith(todayKey)) delete hourAlertSent[k];
  });

  const notStarted = [];
  const hourAlerts = [];
  const quickInsights = []; // { userName, lines[] } lines by project

  for (const user of users) {
    try {
      console.log(`üöÄ Checking user: ${user.name}`);
      const inProg = await getInProgressEntry(user.clockifyId);

      if (!inProg) {
        console.log(`‚õî ${user.name} has NOT started Clockify`);
        notStarted.push(user);
      } else {
        console.log(`‚úÖ ${user.name} has an ACTIVE timer`);
        // >1 hour alert on the active timer
        const startTime = new Date(inProg.timeInterval.start);
        const durHr = (new Date() - startTime) / 3_600_000;
        const alertKey = `${user.clockifyId}_${todayKey}`;
        if (durHr > 1 && !hourAlertSent[alertKey]) {
          hourAlerts.push({
            ...user,
            duration: durHr.toFixed(2),
            project: inProg.projectId || 'Unknown',
          });
          hourAlertSent[alertKey] = true;
        }
      }

      // ‚Äî‚Äî Quick ‚Äúproject time‚Äù insight for TODAY ‚Äî‚Äî
      const todaysEntries = await getTodayEntries(user.clockifyId);
      const byProject = summarizeByProject(todaysEntries);
      if (byProject.length > 0) {
        const lines = byProject
          .slice(0, 3) // keep it short
          .map(p => `‚Ä¢ ${p.projectId}: ${hrs(p.ms)} h (${p.count} entries)`);
        quickInsights.push({ userName: user.name, lines });
      } else {
        quickInsights.push({ userName: user.name, lines: ['‚Ä¢ No time tracked today'] });
      }
    } catch (err) {
      console.error(`‚ùå Error checking ${user.name}:`, err.message);
      notStarted.push({ ...user, error: err.message });
    }
  }

  // ‚Äî Notify users who haven‚Äôt started + admin summary ‚Äî
  try {
    if (notStarted.length > 0) {
      for (const u of notStarted) {
        try {
          await sendWhatsAppMessage(u.phone, `‚ö†Ô∏è You haven't started your Clockify timer today. Please start it now.`);
        } catch (e) {
          console.error(`‚ùå Failed to message ${u.name}:`, e.message);
        }
      }
      const details = notStarted.map(u => `${u.name}${u.error ? ` (error: ${u.error})` : ''}`).join('\n');
      await sendWhatsAppMessage(adminPhone, `‚ö†Ô∏è Clockify Alert:\nThe following users have not logged time today:\n${details}`);
    } else {
      await sendWhatsAppMessage(adminPhone, `‚úÖ All users have logged time today.`);
    }
  } catch (e) {
    console.error('‚ùå Failed to send ‚Äúnot started‚Äù WhatsApp messages:', e.message);
  }

  // ‚Äî Funny hour alerts ‚Äî
  for (const u of hourAlerts) {
    const msg = `üê¢ You Are Working Like a Turtle! Be a Rabbit, Be Fast! (You‚Äôve been on this project for ${u.duration} hours)`;
    try {
      await sendWhatsAppMessage(u.phone, msg);
    } catch (e) {
      console.error(`‚ùå Failed to send hour alert to ${u.name}:`, e.message);
    }
  }
  if (hourAlerts.length) {
    const adminMsg = `üê¢ Turtle Alert:\n${hourAlerts.map(u => `${u.name} (${u.duration} hr) - timer > 1 hr`).join('\n')}`;
    try { await sendWhatsAppMessage(adminPhone, adminMsg); } catch {}
  }

  // ‚Äî Short ‚Äúproject time‚Äù insights (admin, compact) ‚Äî
  try {
    // Send this every 10 minutes with the main check (kept brief)
    const blocks = quickInsights.map(q =>
      `üë§ ${q.userName}\n${q.lines.join('\n')}`
    ).join('\n\n');

    await sendWhatsAppMessage(
      adminPhone,
      `üìä Quick Project Time (Today, IST)\n${blocks}`
    );
  } catch (e) {
    console.error('‚ùå Failed to send quick insights:', e.message);
  }
}

module.exports = checkUsersStarted;
